#!/usr/bin/perl


# Wish list
#
# divide magical and physical protection
#
# add verbosity levels
#
# add audacity for apollo
# add hou yi
# add poison darts for xbal
# add kali
# add arachne
# add nemesis
# add ne zha
#

use strict;
use warnings;

use Getopt::Std;
use Getopt::Long;

#################################################################################
# declare globals
#################################################################################


my %opts;

my $VERBOSITY_QUIET = 1;
my $VERBOSITY_NORMAL = 3;
my $VERBOSITY_EXTRA = 5;
my $VERBOSITY_EPIC = 7;
my $VERBOSITY_LEGENDARY = 9;

# set defaults
$opts{ "enemy" } = "bastet";
$opts{ "verbosity" } = $VERBOSITY_NORMAL;
$opts{ "action" } = "kill";
$opts{ "time" } = 5100;
$opts{ "level" } = 20;

GetOptions( 'god=s' => \$opts{ "god" },
            'enemy=s' => \$opts{"enemy"},
            'items=s' => \$opts{"items"},
            'enemy_items=s' => \$opts{"enemy_items"},
            'verbosity=i' => \$opts{"verbosity"},
            'action=s' => \$opts{"action"},
            'time=i' => \$opts{"time"},
            'iterations=i' => \$opts{"iterations"},
            'level=i' => \$opts{"level"} );

if ( not defined $opts{ "god" } or not defined $opts{ "items" } ) {
    print "god and items are required options\n";
    exit;
}

my @items = split( /\s/, $opts{ "items" } );

my %items;

foreach my $item (@items) {
    $items{ $item } = 1;
}




my %protection_stats = (
    "physical_protection" => {
        "bastet" => (12 + 2.9 * $opts{"level"}),
        "sol" => (9 + 2.6 * $opts{"level"}),
        "khepri" => (19 + 3 * $opts{"level"}), # TODO do this for base god stats too
        "bellona" => (18 + 3 * $opts{"level"}),
        "hercules" => (18 + 3 * $opts{"level"}),
    },
    "magical_protection" => {
        "bastet" => (30 + 0.9 * $opts{"level"}),
        "sol" => 30,
        "khepri" => (30 + 0.9 * $opts{"level"}),
        "bellona" => (30 + 0.9 * $opts{"level"}),
        "hercules" => (30 + 0.9 * $opts{"level"}),
    },
    "health" => {
        "bastet" => (415 + 80 * $opts{"level"}),
        "sol" => (400 + 75 * $opts{"level"}),
        "khepri" => (510 + 90 * $opts{"level"}),
        "bellona" => (480 + 85 * $opts{"level"} ),
        "hercules" => (480 + 86 * $opts{"level"}),
    },
    "default_items" => {
        "bastet" => "bov",
        "sol" => "",
        "khepri" => "urchin bulwark winged_blade bov",
        "bellona" => "bulwark urchin mystical_mail frostbound",
        "hercules" => "thebes gaia bulwark urchin",
    },
);


my @enemy_items;

if (defined $opts{"enemy_items"} ) {
    @enemy_items = split( /\s/, $opts{ "enemy_items" } );
} else {
    @enemy_items = split( /\s/, $protection_stats{ "default_items" }->{ $opts{"enemy" } } );
}

my %enemy_items;

foreach my $item (@enemy_items) {
    $enemy_items{ $item } = 1;
}



my %ability_stats = (
    "cooldown" => {
        "crush" => 10,
        "sic_em" => 10,
        "sentinel" => 15,
        "im_a_monster" => 90,

        "whirlwind" => 15, # TODO scales
        "zephyr" => 7,
        "slipstream" => 15,
        "nine_winds" => 80,

        "moonlight_charge" => 12,
        "feather_step" => 8,
        "gravity_surge" => 90,

        "stellar_burst" => 12,
        "radiance" => 15,

        "irradiate" => 11,
        "pulse" => 11,

        "shadow_lock" => 10,
        "siphon_darkness" => 15,
        "shadow_step" => 15,
        "night_terror" => 90,

        "acid_spray" => 14,
        "viper_shot" => 10,

        "suppress_the_insolent" => 10,
        "vengeful_assault" => 14, # TODO this cooldown scales

        "feather_step" => 8,

        "deathbane" => 10,
        "cobras_kiss" => 18,
        "ambush" => 15,
        "last_breath" => 90,

        "mjolnirs_attunement" => 12,
        "tectonic_rift" => 17,
        "spin_to_win" => 13,
        "anvil_of_dawn" => 90,

        "unchained" => 15,
        "brutalize" => 14,
        "ragnarok" => 90,
        
        "pounce" => 12,
        "razor_whip" => 15,
        "declaw" => 10,
        "cat_call" => 90,

        "spirit_arrow" => 15,

        "thrown_axe" => 14,
        "hail_of_arrows" => 15,
        "bladed_arrow" => 14,

        "training_exercise" => 15,
    },
    "time" => { # will be updated with cooldown when used
        "crush" => 0,
        "sic_em" => 0,
        "sentinel" => 0,
        "im_a_monster" => 0,

        "moonlight_charge" => 0,
        "feather_step" => 0,
        "gravity_surge" => 0,

        "whirlwind" => 0,
        "zephyr" => 0,
        "slipstream" => 0,
        "nine_winds" => 0,

        "stellar_burst" => 0,
        "radiance" => 0,

        "irradiate" => 0,
        "pulse" => 0,

        "acid_spray" => 0,
        "viper_shot" => 0,

        "suppress_the_insolent" => 0,
        "vengeful_assault" => 0,

        "shadow_lock" => 0,
        "siphon_darkness" => 0,
        "shadow_step" => 0,
        "night_terror" => 0,

        "feather_step" => 0,

        "deathbane" => 0,
        "cobras_kiss" => 0,
        "ambush" => 0,
        "last_breath" => 0,

        "mjolnirs_attunement" => 0,
        "tectonic_rift" => 0,
        "spin_to_win" => 0,
        "anvil_of_dawn" => 0,

        "unchained" => 0,
        "brutalize" => 0,
        "ragnarok" => 0,

        "pounce" => 12,
        "razor_whip" => 15,
        "declaw" => 10,
        "cat_call" => 90,

        "spirit_arrow" => 0,

        "thrown_axe" => 0,
        "hail_of_arrows" => 0,
        "bladed_arrow" => 0,

        "training_exercise" => 0,
    },
    "damage" => {
        "crush" => [ 0, 90, 140, 190, 240, 290 ],
        "sic_em" => [ 0, 60, 110, 160, 210, 260 ],
        "sentinel" => [ 0, 0, 0, 0, 0, 0 ],
        "im_a_monster" => [ 0, 400, 500, 600, 700, 800 ],

        "whirlwind" => [ 0, 0, 0, 0, 0, 0 ],
        "zephyr" => [ 0, 60, 105, 150, 195, 240 ],
        "slipstream" => [ 0, 0, 0, 0, 0, 0 ],
        "nine_winds" => [ 0, 400, 500, 600, 700, 800 ],

        "moonlight_charge" => [ 0, 90, 130, 170, 210, 250],
        "feather_step" => [ 0, 120, 180, 240, 300, 360],
        "gravity_surge" => [ 0, 200, 250, 300, 350, 400],

        "irradiate" => [ 0, 40, 55, 70, 85, 100 ],
        "pulse" => [ 0, 20, 30, 40, 50, 60 ],

        "stellar_burst" => [ 0, 40, 70, 100, 130, 160 ],

        "acid_spray" => [ 0, 90, 135, 180, 225, 270 ],
        "viper_shot" => [ 0, 0, 0, 0, 0, 0 ],

        "suppress_the_insolent" => [ 0, 80, 130, 180, 230, 280 ],
        "vengeful_assault" => [ 0, 0, 0, 0, 0, 0 ],

        "shadow_lock" => [ 0, 0, 0, 0, 0, 0 ],
        "siphon_darkness" => [ 0, 90, 160, 230, 300, 370 ],
        "shadow_step" => [ 0, 70, 110, 150, 190, 230 ],
        "night_terror" => [ 0, 200, 250, 300, 350, 400 ],

        "deathbane" => [ 0, 60, 80, 100, 120, 140 ],
        "cobras_kiss" => [ 0, 50, 70, 90, 110, 130 ],
        "ambush" => [ 0, 80, 140, 200, 260, 320 ],
        "last_breath" => [ 0, 0, 0, 0, 0, 0 ],

        "mjolnirs_attunement" => [ 0, 150, 270, 390, 510, 690 ],
        "tectonic_rift" => [ 0, 0, 0, 0, 0, 0 ],
        "spin_to_win" => [ 0, 0, 0, 0, 0, 0 ],
        "anvil_of_dawn" => [ 0, 150, 200, 250, 300, 350 ],

        "unchained" => [ 0, 95, 155, 215, 275, 335 ],
        "brutalize" => [ 0, 45, 75, 105, 135, 165 ],
        "ragnarok" => [ 0, 200, 275, 350, 425, 500 ],

        "pounce" => [ 0, 80, 145, 210, 275, 340 ],
        "razor_whip" => [ 0, 0, 0, 0, 0, 0 ],
        "declaw" => [ 0, 70, 120, 170, 220, 270 ],
        "cat_call" => [ 0, 0, 0, 0, 0, 0 ],

        "spirit_arrow" => [ 0, 180, 310, 440, 570, 700 ],

        "thrown_axe" => [ 0, 60, 90, 120, 150, 180 ],
        "hail_of_arrows" => [ 0, 80, 120, 160, 200, 240 ],
        "bladed_arrow" => [ 0, 70, 120, 170, 220, 270 ],

        "training_exercise" => [ 0, 70, 120, 170, 220, 270 ],
    },
    "aoe" => { # for clear calculations, how many minions hit
        "crush" => 6,
        "sic_em" => 1,
        "sentinel" => 0,
        "im_a_monster" => 0,

        "moonlight_charge" => 6,
        "feather_step" => 3,
        "gravity_surge" => 0,

        "whirlwind" => 6,
        "zephyr" => 1,
        "slipstream" => 0,
        "nine_winds" => 0,

        "stellar_burst" => 6,

        "viper_shot" => 1,
        "acid_spray" => 6,

        "suppress_the_insolent" => 3,

        "shadow_lock" => 0,
        "siphon_darkness" => 6,
        "shadow_step" => 0,
        "night_terror" => 0,

        "deathbane" => 3,
        "cobras_kiss" => 1,
        "ambush" => 0,
        "last_breath" => 0,

        "mjolnirs_attunement" => 6,
        "tectonic_rift" => 0,
        "spin_to_win" => 3,
        "anvil_of_dawn" => 0,

        "unchained" => 3,
        "brutalize" => 3,
        "ragnarok" => 1,

        "pounce" => 3,
        "razor_whip" => 3,
        "declaw" => 1,
        "cat_call" => 0,

        "spirit_arrow" => 6,

        "thrown_axe" => 1, # TODO does this pierce?
        "hail_of_arrows" => 3,
        "bladed_arrow" => 6,

        "training_exercise" => 6,
    },
    "hits" => {
        "crush" => 1,
        "sic_em" => 1,
        "sentinel" => 0,
        "im_a_monster" => 1,

        "moonlight_charge" => 1,
        "feather_step" => 1,
        "gravity_surge" => 1,

        "whirlwind" => 0,
        "zephyr" => 1,
        "slipstream" => 0,
        "nine_winds" => 1,

        "stellar_burst" => 2,

        "acid_spray" => 1,
        "viper_shot" => 0,

        "suppress_the_insolent" => 1,
        "vengeful_assault" => 0,

        "shadow_lock" => 0,
        "siphon_darkness" => 1,
        "shadow_step" => 1,
        "night_terror" => 1,

        "deathbane" => 3,
        "cobras_kiss" => 2,
        "ambush" => 0,
        "last_breath" => 0,

        "mjolnirs_attunement" => 1,
        "tectonic_rift" => 0,
        "spin_to_win" => 1,
        "anvil_of_dawn" => 1,

        "unchained" => 1,
        "brutalize" => 4,
        "ragnarok" => 1,

        "pounce" => 1,
        "razor_whip" => 0,
        "declaw" => 1,
        "cat_call" => 0,

        "spirit_arrow" => 1,

        "thrown_axe" => 1,
        "hail_of_arrows" => 1,
        "bladed_arrow" => 1,

        "training_exercise" => 1,
    },
    "tick_damage" => {
        "viper_shot" => [ 0, 10, 15, 20, 25, 30 ],

        "whirlwind" => [ 0, 10, 20, 30, 40, 50 ],

        "shadow_lock" => [ 0, 30, 40, 50, 60, 70 ],
        "night_terror" => [ 0, 20, 25, 30, 35, 40 ],

        "last_breath" => [ 0, 46, 68, 91, 114, 137 ],

        "spin_to_win" => [ 0, 20, 40, 60, 80, 100 ],

        "razor_whip" => [ 0, 25, 45, 65, 85, 105 ],
        "cat_call" => [ 0, 75, 105, 135, 165, 195 ],
    },
    "scaling" => {
        "crush" => 0.8,
        "sic_em" => 0.6,
        "sentinel" => 0,
        "im_a_monster" => 1.2,

        "moonlight_charge" => 0.6,
        "feather_step" => 1,
        "gravity_surge" => 0.8,

        "whirlwind" => 0,
        "zephyr" => 0.6,
        "slipstream" => 0,
        "nine_winds" => 1.2,

        "stellar_burst" => 0.35,

        "acid_spray" => 0.7,
        "viper_shot" => 0,

        "suppress_the_insolent" => 0.4,
        "vengeful_assault" => 0,

        "shadow_lock" => 0,
        "siphon_darkness" => 1,
        "shadow_step" => 0.4,
        "night_terror" => .6,

        "deathbane" => .45,
        "cobras_kiss" => .4,
        "ambush" => .5,
        "last_breath" => 0,

        "mjolnirs_attunement" => 0.9,
        "tectonic_rift" => 0,
        "spin_to_win" => 0,
        "anvil_of_dawn" => 1.2,

        "unchained" => .8,
        "brutalize" => .5,
        "ragnarok" => 1.2,

        "pounce" => 1,
        "razor_whip" => 0,
        "declaw" => 1,
        "cat_call" => 0,

        "spirit_arrow" => 1.8,

        "thrown_axe" => 0.6,
        "hail_of_arrows" => 1.2,
        "bladed_arrow" => 0.7,

        "training_exercise" => 0.8,
    },
    "tick_scaling" => {
        "viper_shot" => 0.1,

        "whirlwind" => 0.15,

        "shadow_lock" => 0.2,
        "night_terror" => .05,

        "last_breath" => 0,

        "spin_to_win" => 0.45,

        "razor_whip" => 0.25,
        "cat_call" => 0.6,
    },
    "tick_duration" => {
        "shadow_lock" => .5,
        "night_terror" => 1,

        "whirlwind" => 0.5,

        "last_breath" => 1,

        "spin_to_win" => 0.4,

        "razor_whip" => 1,
        "cat_call" => 1,
    },
    "num_ticks" => {
        "crush" => 0,
        "sic_em" => 0,
        "sentinel" => 0,
        "im_a_monster" => 0,

        "moonlight_charge" => 0,
        "feather_step" => 0,
        "gravity_surge" => 0,

        "whirlwind" => 5,
        "zephyr" => 0,
        "slipstream" => 0,
        "nine_winds" => 0,

        "stellar_burst" => 0,

        "acid_spray" => 0,
        "viper_shot" => 0,

        "suppress_the_insolent" => 0,
        "vengeful_assault" => 0,

        "shadow_lock" => 4,
        "siphon_darkness" => 0,
        "shadow_step" => 0,
        "night_terror" => 5,

        "deathbane" => 0,
        "cobras_kiss" => 0,
        "ambush" => 0,
        "last_breath" => 5,

        "mjolnirs_attunement" => 0,
        "tectonic_rift" => 0,
        "spin_to_win" => 5,
        "anvil_of_dawn" => 0,

        "unchained" => 0,
        "brutalize" => 0,
        "ragnarok" => 0,

        "pounce" => 0,
        "razor_whip" => 4,
        "declaw" => 0,
        "cat_call" => 10,

        "spirit_arrow" => 0,

        "thrown_axe" => 0,
        "hail_of_arrows" => 0,
        "bladed_arrow" => 0,

        "training_exercise" => 0,
    },
    "next_action" => { # time to next action
        # these are mostly guesses
        "crush" => 0.5,
        "sic_em" => 0.5,
        "sentinel" => 0.5,
        "im_a_monster" => 1,

        "moonlight_charge" => 0.5,
        "feather_step" => 0.5,
        "gravity_surge" => 0.5,

        "whirlwind" => 0.5,
        "zephyr" => 0.5,
        "slipstream" => 0.5,
        "nine_winds" => 0.5,

        "stellar_burst" => 0.5,

        "acid_spray" => 0.5,
        "viper_shot" => 0.5,

        "suppress_the_insolent" => 0.5,
        "vengeful_assault" => 0.5,

        "shadow_lock" => 2,
        "siphon_darkness" => 0.5,
        "shadow_step" => 0.5,
        "night_terror" => 1,

        "deathbane" => 1,
        "cobras_kiss" => 0.5,
        "ambush" => 0.5,
        "last_breath" => 1,

        "mjolnirs_attunement" => 0.5,
        "tectonic_rift" => 0.5,
        "spin_to_win" => 2,
        "anvil_of_dawn" => 0.5, # count from dunk time, not chargeup

        "unchained" => .5,
        "brutalize" => 2,
        "ragnarok" => 2,

        "pounce" => 0.5,
        "razor_whip" => 0.5,
        "declaw" => 0.5,
        "cat_call" => 0.5,

        "spirit_arrow" => 0.5,

        "thrown_axe" => 0.5,
        "hail_of_arrows" => 0.5,
        "bladed_arrow" => 0.5,

        "training_exercise" => 0.5,
    },
    "power_buff" => {
        "expose_weakness" => [ 0, 10, 20, 30, 40, 50 ],
        "branching_bolas" => [ 0, 10, 20, 30, 40, 50 ],
        "gravity_surge" => [ 0, 20, 30, 40, 50, 60 ],
    },
    "attack_speed_buff" => {
        "vengeful_assault" => [ 0, 0.35, 0.45, 0.55, 0.65, 0.75 ],

        "wield_bow" => [ 0, 0.05, 0.10, 0.15, 0.20, 0.25 ],

        "viper_shot" => [ 0, 0.40, 0.50, 0.60, 0.70, 0.80 ],

        "gravity_surge" => [ 0, 0.3, 0.4, 0.5, 0.6, 0.7 ],
    },
    "level" => {
        # character level           [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15,16,17,18,19,20 ],

        "crush" =>                  [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "sic_em" =>                 [ 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],
        "sentinel" =>               [ 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 4, 5, 5 ],
        "im_a_monster" =>           [ 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5 ],

        "whirlwind" =>              [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "zephyr" =>                 [ 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],
        "slipstream" =>             [ 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 4, 5, 5 ],
        "nine_winds" =>             [ 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5 ],

        "irradiate" =>              [ 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],
        "pulse" =>                  [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],

        "stellar_burst" =>          [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "radiance" =>               [ 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],

        "suppress_the_insolent" =>  [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "vengeful_assault" =>       [ 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],

        "viper_shot" =>             [ 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],
        "acid_spray" =>             [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],

        "siphon_darkness" =>        [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "shadow_lock" =>            [ 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],
        "shadow_step" =>            [ 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 4, 5, 5 ],
        "night_terror" =>           [ 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5 ],

        "deathbane" =>              [ 0, 1, 1, 1, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "cobras_kiss" =>            [ 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],
        "ambush" =>                 [ 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 4, 5, 5 ],
        "last_breath" =>            [ 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5 ],

        "feather_step" =>           [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "moonlight_charge" =>       [ 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],
        "gravity_surge" =>          [ 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5 ],

        "mjolnirs_attunement" =>    [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "tectonic_rift" =>          [ 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 4, 5, 5 ],
        "spin_to_win" =>            [ 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],
        "anvil_of_dawn" =>          [ 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5 ],

        "brutalize" =>              [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "unchained" =>              [ 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],
        "ragnarok" =>               [ 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5 ],

        "razor_whip" =>             [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "pounce" =>                 [ 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 4, 4, 5, 5, 5, 5, 5, 5, 5 ],
        "declaw" =>                 [ 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 4, 5, 5 ],
        "cat_call" =>               [ 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5 ],

        "spirit_arrow" =>           [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],

        "thrown_axe" =>             [ 0, 0, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "bladed_arrow" =>           [ 0, 0, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "expose_weakness" =>        [ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 3, 4, 5, 5 ],
        "hail_of_arrows" =>         [ 0, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
        "weild_bow" =>              [ 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5 ],

        "training_exercise" =>      [ 0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5 ],
    },
);



my %combos = (
    "scylla" => [ "sic_em", "crush", "im_a_monster" ],
    "nox" => [ "shadow_lock", "siphon_darkness", "night_terror" ],
    "freya" => [ ],
    "sol" => [ "stellar_burst" ],
    "kukulkan" => [ "whirlwind", "zephyr" ],
    "artemis" => [ ],
    "awilix" => [ "moonlight_charge", "gravity_surge" ],
    "medusa" => [ ],
    "xbal" => [ ],
    "rama" => [ ],
    "serqet" => [ "cobras_kiss", "deathbane", "last_breath" ],
    "thor" => [ "anvil_of_dawn", "mjolnirs_attunement", "tectonic_rift", "spin_to_win" ],
    "fenrir" => [ "unchained", "ragnarok" ],
    "bastet" => [ "pounce", "razor_whip", "cat_call" ],
    "apollo" => [ ],
    "mercury" => [ ],
    "neith" => [ "spirit_arrow", ],
    "ullr" => [ "thrown_axe", "hail_of_arrows", "bladed_arrow" ],
    "chiron" => [ ],
);


my %clear_skills = (
    "sol" => [ "stellar_burst" ],
    "freya" => [ ],
    "medusa" => [ "acid_spray" ],
    "artemis" => [ "suppress_the_insolent" ],
    "kukulkan" => [ "whirlwind" ],
    "bastet" => [ "razor_whip" ],
    "apollo" => [ ],
    "fenrir" => [ "brutalize" ],
    "chiron" => [ "training_exercise" ],
);




my %base_stats = (
    "type" => {
        "freya" => "magical",
        "sol" => "magical",
        "scylla" => "magical",
        "nox" => "magical",
        "kukulkan" => "magical",

        "artemis" => "physical",
        "awilix" => "physical",
        "medusa" => "physical",
        "xbal" => "physical",
        "rama" => "physical",
        "ullr" => "physical",
        "serqet" => "physical",
        "thor" => "physical",
        "fenrir" => "physical",
        "bastet" => "physical",
        "apollo" => "physical",
        "neith" => "physical",
        "mercury" => "physical",
        "chiron" => "physical",
    },
    "mvmt_speed" => {
        "mercury" => 375,
    },
    "attack_rate" => {
        "freya" => 0.95,
        "sol" => 1,
        "scylla" => 1,
        "nox" => 1,
        "kukulkan" => 0.87,

        "artemis" => 0.95,
        "awilix" => 1,
        "medusa" => 0.95,
        "xbal" => 0.95,
        "rama" => 0.95,
        "ullr" => 0.95,
        "serqet" => 1,
        "thor" => 1,
        "fenrir" => 1,
        "bastet" => 1,
        "apollo" => 0.95,
        "neith" => 0.95,
        "mercury" => 1,
        "chiron" => 1,
    },
    "attack_rate_level_scaling" => {
        "freya" => 0.0195,
        "sol" => 0.018,
        "scylla" => 0.008,
        "nox" => 0.008,
        "kukulkan" => 0.0091,

        "artemis" => 0.014,
        "awilix" => 0.0189,
        "medusa" => 0.014,
        "xbal" => 0.01,
        "rama" => 0.017,
        "ullr" => 0.015,
        "serqet" => 0.0216,
        "thor" => 0.0145,
        "fenrir" => 0.017,
        "bastet" => 0.0198,
        "apollo" => 0.017,
        "neith" => 0.016,
        "mercury" => 0.024,
        "chiron" => .011,
    },
    "auto_damage" => {
        "freya" => 35,
        "sol" => 34,
        "scylla" => 34,
        "nox" => 34,
        "kukulkan" => 34,

        "artemis" => 35,
        "awilix" => 38,
        "medusa" => 38,
        "xbal" => 37,
        "rama" => 40,
        "ullr" => 38,
        "serqet" => 39,
        "thor" => 39,
        "fenrir" => 38,
        "bastet" => 38,
        "apollo" => 40,
        "neith" => 35,
        "mercury" => 38,
        "chiron" => 35,
    },
    "auto_level_scaling" => {
        "freya" => 1.5,
        "sol" => 1.45,
        "scylla" => 1.45,
        "nox" => 1.5,
        "kukulkan" => 1.45,

        "artemis" => 2.05,
        "awilix" => 2.16,
        "medusa" => 2.6,
        "xbal" => 2.5,
        "rama" => 2.5,
        "ullr" => 2.4,
        "serqet" => 2.25,
        "thor" => 2.4,
        "fenrir" => 2.3,
        "bastet" => 2.13,
        "apollo" => 2.6,
        "neith" => 2.3,
        "mercury" => 2.13,
        "chiron" => 2.35,
    },
    "mana" => {
        "freya" => 220,
        "sol" => 300,
        "scylla" => 298,
        "nox" => 250,
        "kukulkan" => 265,

        "artemis" => 205,
        "awilix" => 220,
        "medusa" => 220,
        "xbal" => 220,
        "rama" => 205,
        "ullr" => 230,
        "serqet" => 240,
        "thor" => 240,
        "fenrir" => 200,
        "bastet" => 215,
        "apollo" => 225,
        "neith" => 230,
        "mercury" => 200,
        "chiron" => 225,
    },
    "mana_level_scaling" => {
        "freya" => 37,
        "sol" => 57,
        "scylla" => 56,
        "nox" => 38,
        "kukulkan" => 45,

        "artemis" => 34,
        "awilix" => 38,
        "medusa" => 34,
        "xbal" => 37,
        "rama" => 34,
        "ullr" => 40,
        "serqet" => 40,
        "thor" => 38,
        "fenrir" => 35,
        "bastet" => 39,
        "apollo" => 40,
        "neith" => 39,
        "mercury" => 40,
        "chiron" => 40,
    },
    "attack_chain_progression" => {
        "freya" => [ 1 ],
        "sol" => [ 1 ],
        "scylla" => [ 1 ],
        "nox" => [ 1 ],
        "kukulkan" => [ 1 ],

        "artemis" => [ 1 ],
        "awilix" => [ 1, 0.75, 1.25 ],
        "medusa" => [ 1 ],
        "xbal" => [ 1 ],
        "rama" => [ 1 ],
        "ullr" => [ 1 ],
        "serqet" => [ 1, 0.75, 1.25 ],
        "thor" => [ 1 ],
        "fenrir" => [ 1 ],
        "bastet" => [ 1, 0.7, 1.3 ],
        "apollo" => [ 1 ],
        "neith" => [ 1 ],
        "mercury" => [ 1, 0.75, 1.25 ],
        "chiron" => [ 1 ],
    },
);



my @attack_chain_progression = @{ $base_stats{ "attack_chain_progression" }->{ $opts{ "god" } } };
my $next_attack_chain = 0;

my %messages_to_print;
my @one_pass_verbosity;

my $attack_rate = $base_stats{ "attack_rate" }->{ $opts{ "god" } }
        + $opts{ "level" } * $base_stats{ "attack_rate_level_scaling" }->{ $opts{ "god" } }
        * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
my $mana = $base_stats{ "mana" }->{ $opts{ "god" } }
        + $opts{ "level" } * $base_stats{ "mana_level_scaling" }->{ $opts{ "god" } };

my $base_crit_chance = 0;
my $crits = 0;
my $damage = 0;
my $attack_damage = 0;
my $malice_damage = 0;
my $time = 0;
my $next_attack = 0;
my $num_attacks = 0;
my $total_attacks = 0;
my $gold = 0;

my $physical_power = 0;
my $magical_power = 0;
my $lifesteal = 0;
if ( $opts{ "god" } eq "freya" ) { $lifesteal += 0.15; }
my $cdr = 0;
my $item_mvmt_speed = 0;

my $their_phys_prot = $protection_stats{ "physical_protection" }->{ $opts{"enemy"} };
my $their_mag_prot = $protection_stats{ "magical_protection" }->{ $opts{"enemy"} };
if ( $opts{"action"} eq "clear" ) {
    $their_phys_prot = 0;
    $their_mag_prot = 0;
} # minions

my $their_health = $protection_stats{ "health" }->{ $opts{"enemy"} };

my $their_percent_reduction = 0;
if ( $opts{"action"} eq "clear" ) {
    $their_percent_reduction = 0.1; # at the start of the match
}

my $flat_pen = 0;
my $percent_pen = 0;
my $flat_reduction = 0;
my $percent_reduction = 0;

#################################################################################
# magical items
#################################################################################

if (defined $items{"purple_pot"} ){
    $magical_power += 50;
    $gold += 450;
}

if (defined $items{"vamp_shroud"} ) {
    $magical_power += 20;
    $gold += 800;
}

if (defined $items{"ancient_blade"} ) {
    $attack_rate += 0.1 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
    $gold += 590;
}

if (defined $items{"emerald_ring"}) {
    $magical_power += 20;
    $attack_rate += 0.05 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
    $gold += 690;
}

if (defined $items{"enchanted_ring"}) {
    $magical_power += 30;
    $attack_rate += 0.1 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
    $gold += 1075;
}

if (defined $items{"lost_artifact"} ){
    $magical_power += 15;
    $gold += 600;
}

if (defined $items{"tiny_trinket"} ){
    $magical_power += 20;
    $lifesteal += 0.04;
    $gold += 540;
}

if (defined $items{"pen_boots"}) {
    $magical_power += 45;
    $flat_pen += 10;
    $gold += 1600;
}

if (defined $items{"cooldown_boots"}) {
    $magical_power += 30;
    $cdr += 0.10;
    $mana += 250;
    $gold += 1500;
}

if (defined $items{"void_stone"}) {
    $magical_power += 40;
    $flat_reduction += 15;
    $gold += 2350;
}

if (defined $items{"demonic_grip"}) {
    $attack_rate += $base_stats{ "attack_rate" }->{ $opts{ "god" } }* 0.25;
    $magical_power += 60;
    $gold += 2280;
}

if (defined $items{"telkhines_ring"} or defined $items{ "telkhines" }) {
    $attack_rate += 0.3 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
    $magical_power += 45;
    $gold += 2125;
}

if (defined $items{ "spear_of_desolation" }) {
    $magical_power += 120;
    $flat_pen += 20;
    $gold += 3800;
}

if (defined $items{"fatalis"}) {
    $attack_rate += $base_stats{ "attack_rate" }->{ $opts{ "god" } }* 0.3;
    $gold += 2140;
}

if (defined $items{"polynomicon"}) {
    $magical_power += 75;
    $mana += 300;
    $lifesteal += .1;
    $gold += 2300;
}

if (defined $items{"spear"}) {
    $magical_power += 45;
    $flat_pen += 15;
    $gold += 2150;
}

if (defined $items{"shard"}) {
    $magical_power += 70;
    $percent_pen += .33;
    $gold += 2050;
}

if (defined $items{"bancrofts"}) {
    $magical_power += 100;
    $lifesteal += .12;
    $gold += 2400;
}

if (defined $items{"rod"}) {
    $magical_power += 125;
    $gold += 3320;
}

if (defined $items{"chronos"}) {
    $magical_power += 75;
    $cdr += 0.20;
    $gold += 2400;
}

if (defined $items{"pythagorems"} or defined $items{"pythags"}) {
    $magical_power += 90;
    $lifesteal += .25;
    $cdr += 0.1;
    $gold += 2600;
}

if (defined $items{"gem"} ) {
    $magical_power += 70;
    $mana += 250;
    $gold += 2850;
}

if (defined $items{"doom_orb"} ){
    $magical_power += 140; #assume full stacks
    $mana += 200;
    $gold += 2050;
}

if (defined $items{"book"}) {
    $mana += 875;
    $magical_power += 100 + 0.03 * $mana; # TODO having this last computes bonus right... probably?
    $gold += 2650;
}

#################################################################################
# physical items
#################################################################################

if (defined $items{"red_pot"} ){
    $physical_power += 20;
    $gold += 450;
}

if (defined $items{"throwing_dagger"} ){
    $physical_power += 20;
    $base_crit_chance += 0.1;
    $gold += 1300;
}

if (defined $items{ "charged_morningstar" } ) {
    $physical_power += 20;
    $mana += 150;
    $gold += 1200;
}

if (defined $items{ "bluestone" } ) {
    $physical_power += 15;
    $mana += 100;
    $gold += 800;
}

# jotunn's wrath
if (defined $items{"jotunns"} or defined $items{ "jotunns_wrath" }) {
    $physical_power += 40;
    $flat_pen += 10;
    $mana += 150;
    $cdr += 0.20;
    $gold += 2440;
}

# qin's sais
if (defined $items{"qins"}) {
    $attack_rate += 0.15 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
    $physical_power += 40;
    $gold += 2700;
}

# asi
if (defined $items{"asi"}) {
    $flat_pen += 15;
    $lifesteal += 0.15;
    $attack_rate += 0.2 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
    $gold += 1780;
}

# brawler's beatstick
if (defined $items{"brawlers"}) {
    $physical_power += 40;
    $flat_pen += 20;
    $gold += 2400;
}

# titan's bane
if (defined $items{"titans"} or defined $items{"titans_bane"}) {
    $physical_power += 30;
    $percent_pen += 0.33;
    $gold += 2050;
}

# warrior tabi
if (defined $items{"warrior_tabi"}) {
    $physical_power += 40;
    $gold += 1550;
    $item_mvmt_speed += 0.18;
}

# ninja tabi
if (defined $items{"ninja_tabi"}) {
    $physical_power += 20;
    $attack_rate += 0.15 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
    $gold += 1500;
    $item_mvmt_speed += 0.18;
}

# executioner
if (defined $items{"executioner"}) {
    $physical_power += 30;
    $attack_rate += 0.25 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
    $gold += 2250;
}

# ichaival
if (defined $items{"ichaival"}) {
    $attack_rate += 0.3 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
    $flat_pen += 10;
    $gold += 1700;
}

# dev's gloves
if (defined $items{"devs_gloves"}) {
    $physical_power += 55;
    $lifesteal += 0.25; # assume full stacks
    $gold += 2050;
}

# soul eater
if (defined $items{"soul_eater"}) {
    $attack_rate += 0.30 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
    $lifesteal += 0.3; # assume full stacks
    $item_mvmt_speed += 0.1;
    $gold += 2000;
}

# stone cutting sword
if (defined $items{"stone_cutting_sword"} or defined $items{ "scs" }) {
    $physical_power += 50;
    $item_mvmt_speed += .1;
    $gold += 2900;
}

# masamune
if (defined $items{"masamune"}) {
    $physical_power += 30;
    $item_mvmt_speed += .1;
    $gold += 2200;
}

# heartseeker
if (defined $items{ "heartseeker" }) {
    $physical_power += 25;
    $item_mvmt_speed += 0.1;
    $attack_rate += 0.15 * $base_stats{ "attack_rate" }->{ $opts{ "god" } }; # assume stacked
    #TODO deal with heartseeker stacks
}

# golden bow
if (defined $items{"golden_bow"}) {
    $base_crit_chance += 0.1;
    $physical_power += 35;
    $gold += 2330;
    $item_mvmt_speed += 0.05;
}

# odysseus bow
if (defined $items{"obow"}) {
    $attack_rate += 0.4 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
}

if (defined $items{"charged_bow"}) {
    $attack_rate += 0.2 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
}

# rage
if (defined $items{"rage"}) {
    $base_crit_chance += 0.2;
    $physical_power += 30;
    $gold += 2600;
}

# malice
if (defined $items{"malice"}) {
    $base_crit_chance += 0.2;
    $physical_power += 50;
    $gold += 3000;
}
my $total_malice_procs = 0;
my $next_malice_proc = 0;
my $malice_procs_left = 0;

# deathbringer
if (defined $items{"deathbringer"} or defined $items{ "db" }) {
    $base_crit_chance += 0.2;
    $physical_power += 50;
    $gold += 3200;
}

# hydras lament
if (defined $items{"hydras"}) {
    $cdr += 0.15;
    $physical_power += 30;
}

# transcendence
if (defined $items{"transcendence"}) {
    $mana += 1050;
    $physical_power += 35;
    $physical_power += 0.03 * $mana; # TODO having this last computes bonus right... probably?
    $gold += 2600;
}

#################################################################################
# enemy items (defensive)
#################################################################################

if (defined $enemy_items{ "bov" }) {
    $their_phys_prot += 75;
}

if (defined $enemy_items{ "bulwark" }) {
    $their_health += 200;
    $their_mag_prot += 60;
}

if (defined $enemy_items{ "urchin" }) {
    $their_health += 250;
    $their_mag_prot += 65;
    $their_phys_prot += 65;
}

if (defined $enemy_items{ "mantle_of_discord" }) {
    $their_phys_prot += 60;
    $their_mag_prot += 60;
}

if (defined $enemy_items{ "spirit_robe" }) {
    $their_phys_prot += 60;
    $their_mag_prot += 60;
}

if (defined $enemy_items{ "magis" }) {
    $their_health += 350;
    $their_mag_prot += 15;
    $their_phys_prot += 15;
}

if (defined $enemy_items{ "mystical_mail" }) {
    $their_health += 350;
    $their_phys_prot += 30;
}

if (defined $enemy_items{ "sov" }) {
    $their_health += 200;
    $their_phys_prot += 50;
}

if (defined $enemy_items{ "midgardian" }) {
    $their_health += 350;
    $their_phys_prot += 30;
}

if (defined $enemy_items{ "nemean" }) {
    $their_phys_prot += 90;
    # TODO handle nemean damage return
}

if (defined $enemy_items{ "spectral_armor" }) {
    $their_phys_prot += 80;
    $lifesteal *= 0.5;
}

if (defined $enemy_items{ "frostbound" }) {
    $their_health += 300;
}

if (defined $enemy_items{ "winged_blade" }) {
    $their_health += 300;
}

if (defined $enemy_items{ "witchblade" }) {
    $their_phys_prot += 45;
    # TODO handle aura
}

if (defined $enemy_items{ "runic_shield" }) {
    $their_mag_prot += 50;
    # TODO handle aura
}

if (defined $enemy_items{ "mail_of_renewal" }) {
    $their_health += 350;
}

if (defined $enemy_items{ "gaia" }) {
    $their_health += 350;
}

if (defined $enemy_items{ "thebes" }) {
    $their_health += 350;
}

if (defined $enemy_items{ "oni" }) {
    $their_mag_prot += 60;
}

if (defined $enemy_items{ "genji" }) {
    $their_mag_prot += 80;
}

#################################################################################
# calculate stats
#################################################################################

if ( $opts{ "god" } eq "scylla" ) {
    if ( $ability_stats{ "level" }->{ "crush" }->[ $opts{ "level" } ] == 5 ) { $magical_power += 20; }
    if ( $ability_stats{ "level" }->{ "sic_em" }->[ $opts{ "level" } ] == 5 ) { $magical_power += 20; }
    if ( $ability_stats{ "level" }->{ "im_a_monster" }->[ $opts{ "level" } ] == 5 ) { $magical_power += 20; }
    if ( $ability_stats{ "level" }->{ "sentinel" }->[ $opts{ "level" } ] == 5 ) { $magical_power += 20; }
}

if ( $opts{ "god" } eq "kukulkan" ) {
    $magical_power += 0.05 * $mana;
}

if (defined $items{"rod"}) { $magical_power *= 1.25; } # does this multiply passives or only items? TODO


# enforce maxima
if ($cdr > 0.4) { $cdr = 0.4; }
if ($attack_rate > 2.5) { $attack_rate = 2.5; }
if ($magical_power > 900) { $magical_power = 900; }
if ($physical_power > 400) { $physical_power = 400; }
if ($flat_pen > 50) { $flat_pen = 50; }


#################################################################################
# iteration and time mgmt
#################################################################################

my $iteration = 0;
my $max_iterations = 1000;
if ( $base_stats{ "type" }->{ $opts{ "god" } } eq "magical" ) {
    $max_iterations = 1; # no crit, no rng
}
if ( $base_crit_chance == 0 and $opts{ "god" } ne "artemis" ) {
    $max_iterations = 1; # no crit, no rng
}
if ( defined $opts{ "iterations" } ) {
    $max_iterations = $opts{"iterations"};
}

#################################################################################
# buffs and stacks
#################################################################################

my %buffs = (
    "max" => {
        "rage" => 6,
        "executioner" => 4, # really a debuff on the target
        "demonic_grip" => 4, # really a debuff on the target
        "spear" => 3, # really a debuff on the target
        "still_target" => 3,
        "xbal_passive" => 6,
        "initiative" => 1,
        "vengeful_assault" => 1,
        "expose_weakness" => 1,
        "pick_me_up" => 1,
        "gravity_surge" => 1,
        "maximum_velocity" => 1,
        "branching_bolas" => 1,
        "open_wound" => 1, # really a debuff on the target
        "serqet_poisons" => 3, # really a debuff on the target
        "hydras_lament" => 1,
        "polynomicon" => 1,
        "ichaival" => 3, # both a buff and a debuff
        "irradiate" => 1,
        "pulse" => 1,
        "astral_strike" => 1,
        "stone_cutting_sword" => 3, # both a buff and a debuff
        "oni" => 3, # buff for enemy
        "spectral_armor" => 1, # buff for enemy
    },
    "current" => {
        "rage" => 0,
        "executioner" => 0, # really a debuff on the target
        "demonic_grip" => 0, # really a debuff on the target
        "spear" => 0, # really a debuff on the target
        "still_target" => 0,
        "xbal_passive" => 0,
        "initiative" => 0,
        "vengeful_assault" => 0,
        "expose_weakness" => 0,
        "pick_me_up" => 0,
        "gravity_surge" => 0,
        "maximum_velocity" => 0,
        "branching_bolas" => 0,
        "open_wound" => 0, # really a debuff on the target
        "serqet_poisons" => 0, # really a debuff on the target
        "hydras_lament" => 0,
        "polynomicon" => 0,
        "ichaival" => 0, # both a buff and a debuff
        "irradiate" => 0,
        "pulse" => 0,
        "astral_strike" => 0,
        "stone_cutting_sword" => 0, # both a buff and a debuff
        "oni" => 3, # buff for enemy, assume this starts fully stacked
        "spectral_armor" => 0, # buff for enemy
    },
    cooldown => {
        "spectral_armor" => 0,
        "polynomicon" => 0,
        "hydras_lament" => 0,
    },
    "time" => { # end time for buffs
        "rage" => 0,
        "executioner" => 0, # really a debuff on the target
        "demonic_grip" => 0, # really a debuff on the target
        "spear" => 0, # really a debuff on the target
        "still_target" => 0,
        "xbal_passive" => 0,
        "initiative" => 0,
        "vengeful_assault" => 0,
        "expose_weakness" => 0,
        "pick_me_up" => 0,
        "gravity_surge" => 0,
        "maximum_velocity" => 0,
        "branching_bolas" => 0,
        "open_wound" => 0, # really a debuff on the target
        "serqet_poisons" => 0, # really a debuff on the target
        "hydras_lament" => 0,
        "polynomicon" => 0,
        "ichaival" => 0, # both a buff and a debuff
        "irradiate" => 0,
        "pulse" => 0,
        "astral_strike" => 0,
        "stone_cutting_sword" => 0, # both a buff and a debuff
        "oni" => 0, # buff for enemy
        "spectral_armor" => 0, # buff for enemy
    },
    "duration" => {
        "rage" => 0,
        "executioner" => 3000, # really a debuff on the target
        "demonic_grip" => 3000, # really a debuff on the target
        "spear" => 5000, # really a debuff on the target
        "still_target" => 4000,
        "xbal_passive" => 0,
        "initiative" => 2500,
        "vengeful_assault" => 5000,
        "expose_weakness" => 5000,
        "pick_me_up" => 5000,
        "gravity_surge" => 6000,
        "maximum_velocity" => 5000,
        "branching_bolas" => 0,
        "open_wound" => 0, # really a debuff on the target
        "serqet_poisons" => 20000, # really a debuff on the target
        "hydras_lament" => 3000, # cooldown time
        "polynomicon" => 3000, # cooldown time
        "ichaival" => 3000, # both a buff and a debuff
        "irradiate" => 5000,
        "pulse" => 5000,
        "astral_strike" => 0,
        "stone_cutting_sword" => 3000, # both a buff and a debuff
        "oni" => 0, # buff for enemy
        "spectral_armor" => 5000, # buff for enemy
    },
);

my $viper_shots_left = 0;
my $astral_arrows = 0;

my $heat = 0;
my @radiance_heat_amount = ( 0, 40, 50, 60, 70, 80 );

my $polynomicon_procs = 0;
my $polynomicon_damage = 0;

my $telkhines_damage = 0;

my $hydras_procs = 0;
my $hydras_damage = 0;

my %ticks = ();

my $combo_idx = 0;
my $next_skill;

my $bluestone_stacks = 0;

my $audacity_stacks = 0;

my $obow_hits = 0;


#################################################################################
# calculations
#################################################################################

sub add_stack($) {
    my $buff = shift;
    $buffs{ "current" }->{ $buff } += 1;
    if ( $buffs{ "current" }->{ $buff } > $buffs{ "max" }->{ $buff } ) {
        $buffs{ "current" }->{ $buff } = $buffs{ "max" }->{ $buff };
    }
}


sub rm_stack($) {
    my $buff = shift;
    $buffs{ "current" }->{ $buff } -= 1;
    if ( $buffs{ "current" }->{ $buff } < 0 ) {
        $buffs{ "current" }->{ $buff } = 0;
    }
}

sub reset_buff_time($) {
    my $buff = shift;
    if ( $buffs{ "duration" }->{ $buff } != 0 ) {
        $buffs{ "time" }->{ $buff } = $time + $buffs{ "duration" }->{ $buff };
    }
}


sub ability_crits($) {
    my $pre_prot_damage = shift;

    # some abilities can crit, but they do not proc rage
    # not sure if the crit chance for abilities is affected by rage stacks TODO

    # crit chance
    my $total_crit_chance = $base_crit_chance;

    my $rng = rand();
    if ( $rng < $total_crit_chance ) {
        # critical hit
        $pre_prot_damage *= 2;
        if (defined $items{ "deathbringer" }) {
            $pre_prot_damage *= 1.2; # 240%
        }

        # handle malice
        if ($malice_procs_left == 0) {
            # no procs, set next proc for 1 sec from now, otherwise just refresh count
            $next_malice_proc = $time + 1000;
        }
        $malice_procs_left = 3;
    }

    return $pre_prot_damage;
}


sub get_eff_power() {
    
    if ( $base_stats{ "type" }->{ $opts{"god"} } eq "physical" ) {
        my $eff_physical_power = $physical_power
                + 5 * $buffs{ "current" }->{ "xbal_passive" }
                + 10 * $buffs{ "current" }->{ "ichaival" }
                + $buffs{ "current" }->{ "gravity_surge" } *
                        $ability_stats{ "power_buff" }->{ "gravity_surge" }->[
                                $ability_stats{ "level" }->{ "gravity_surge" }->[ $opts{ "level" } ] ];
        if (defined $items{ "masamune" }) {
            # TODO does masamune work this way? or is it more like telkhines?
            my $bonus = int(0.1 * ($their_health - 2000)); # 1 for every 10 health diff
            if ($bonus > 50) { $bonus = 50; }
            $eff_physical_power += $bonus;
        }
        if ($buffs{ "current" }->{ "initiative" } > 0) {
            $eff_physical_power *= 1.3;
        }
        return $eff_physical_power
    }
    else
    {
        my $eff_magical_power = $magical_power;
        if ( $opts{ "god" } eq "sol" ) {
            $eff_magical_power *= (1 + 0.25 * $heat / 100);
            $eff_magical_power = int( $eff_magical_power );
        }
        return $eff_magical_power;
    }
}

sub get_mvmt_speed() {
    my $mvmt_speed = $base_stats{ "mvmt_speed" }->{ $opts{"god"} } * ($item_mvmt_speed + 0.4); # assume sprint is active TODO handle sprint duration
    return $mvmt_speed;
}


sub add_bluestone( $ ) {

    my $aoe = shift;

    if ( $bluestone_stacks < 2 ) {

        my $tick = 0;
        
        while ( $tick < 2 ) {

            my $tick_time = $time + ($tick + 1) * 1000;
            while ( defined $ticks{ $tick_time } ) { $tick_time++; }
            $ticks{ $tick_time } = +[ 15, "bluestone tick", 0, $aoe ];

            $tick++;
        }

        $bluestone_stacks++;
    }
}

sub get_basic_attack_damage() {

    if ( $base_stats{ "type" }->{ $opts{"god"} } eq "physical" ) {
        my $eff_physical_base_dmg  = ($base_stats{ "auto_damage" }->{ $opts{ "god" } }
                + $opts{ "level" } * $base_stats{ "auto_level_scaling" }->{ $opts{ "god" } }
                + get_eff_power())
                * ${attack_chain_progression}[ $next_attack_chain ];
        return $eff_physical_base_dmg;
    }
    else
    {
        my $eff_magical_base_dmg = ($base_stats{ "auto_damage" }->{ $opts{ "god" } }
                + $opts{ "level" } * $base_stats{ "auto_level_scaling" }->{ $opts{ "god" } }
                + 0.2 * get_eff_power()) # TODO is magical power scaling always 0.2?
                * ${attack_chain_progression}[ $next_attack_chain ];
        return $eff_magical_base_dmg;
    }
}

sub calc_mitigated_damage( $ $ $ $ ) {

    my $pre_prot_damage = shift;
    my $damage_source = shift;
    my $print = shift;
    my $num_targets = shift;

    my $their_base_prot;
    if ( $base_stats{ "type" }->{ $opts{"god"} } eq "physical" ) {
        # TODO it is possible for physical gods to do magical damage, e.g. with runeforged or nemean
        # and vice versa, e.g., nu wa minions
        $their_base_prot = $their_phys_prot;

        if ($buffs{ "current" }->{ "spectral_armor" } == 1) {
            $their_base_prot += 20;
        }

        if ( $lifesteal > 0 and defined $enemy_items{"spectral_armor"}
            and $buffs{ "cooldown" }->{ "spectral_armor" } <= $time) {
            # spectral is available 
            if( rand() < 0.3 ) {
                # spectral proc
                add_stack("spectral_armor");
                reset_buff_time("spectral_armor");
                $buffs{ "current" }->{ "spectral_armor" } = 1;
                $buffs{ "cooldown" }->{ "spectral_armor" } = $time + 30000;
            }
        }
    } else {
        $their_base_prot = $their_mag_prot;
        if (defined $enemy_items{ "oni" }) {
            $their_base_prot += 15 * $buffs{ "current" }->{ "oni" };
            rm_stack("oni");
        }
    }
    my $their_eff_prot = $their_base_prot;
    $their_eff_prot *= (1 - $percent_reduction);
    $their_eff_prot *= (1 - 0.08 * $buffs{ "current" }->{ "demonic_grip" });
    $their_eff_prot *= (1 - 0.08 * $buffs{ "current" }->{ "executioner" });
    $their_eff_prot -= $flat_reduction;
    $their_eff_prot -= 10 * $buffs{ "current" }->{ "spear" };
    $their_eff_prot -= 10 * $buffs{ "current" }->{ "stone_cutting_sword" };
    $their_eff_prot *= (1 - $percent_pen);
    $their_eff_prot -= $flat_pen;
    if ($their_eff_prot < 0) { $their_eff_prot = 0; }

    my $damage = ( 100 / (100 + $their_eff_prot) ) * $pre_prot_damage;

    #$damage -= $their_flat_reduction;
    $damage *= (1 - $their_percent_reduction);
    
    if ( $opts{ "verbosity" } >= $VERBOSITY_NORMAL and $print) {
        my $output = sprintf "time %6d %16s prot %4d -> %4d damage %4d -> %4d ",
                $time, $damage_source, $their_base_prot, $their_eff_prot, $pre_prot_damage, $damage;
        if ( $opts{"action"} eq "clear" ) {
            $output .= sprintf " * %d -> %d ", $num_targets, ($num_targets * $damage);
        }
        if ( defined $items{ "spear" } ) {
            $output .= sprintf " %d spear stacks ", $buffs{ "current" }->{ "spear" };
        }
        if ( defined $items{ "demonic_grip" } ) {
            $output .= sprintf " %d grip stacks ", $buffs{ "current" }->{ "demonic_grip" };
        }
        if ( defined $items{ "executioner" } ) {
            $output .= sprintf " %d executioner stacks ", $buffs{ "current" }->{ "executioner" };
        }
        if ( defined $items{ "stone_cutting_sword" } or defined $items{ "scs" } ) {
            $output .= sprintf " %d SCS stacks ", $buffs{ "current" }->{ "stone_cutting_sword" };
        }
        if ( defined $enemy_items{ "oni" }) {
            $output .= sprintf " %d oni stacks ", $buffs{ "current" }->{ "oni" };
        }
        $output .= "\n";
        push @one_pass_verbosity, $output;
        if ( $opts{ "verbosity" } >= $VERBOSITY_EPIC ) {
            print $output;
        }
    }
    
    return ($num_targets * $damage);

}


#################################################################################
# skill ordering and cooldowns
#################################################################################
sub get_next_skill() {
    if ( $opts{"action"} eq "clear" ) {
        if ( scalar( $clear_skills{ $opts{ "god" } } ) == 0 ) {
            return undef;
        }
        if ( scalar( $clear_skills{ $opts{ "god" } } ) < $combo_idx ) {
            $combo_idx = 0;
        }
        return $clear_skills{ $opts{ "god" } }->[ $combo_idx ];
    }
    else
    {
        if ( scalar( $combos{ $opts{ "god" } } ) == 0 ) {
            return undef;
        }
        if ( scalar( $combos{ $opts{ "god" } } ) < $combo_idx ) {
            $combo_idx = 0;
        }
        return $combos{ $opts{ "god" } }->[ $combo_idx ];
    }
}

#################################################################################
# main loop
#################################################################################




while ( $iteration < $max_iterations ) {

    @one_pass_verbosity = ();

    while ( $time < $opts{"time"} ) {

        # stuff that happens FIRST
        if ($opts{ "god" } eq "awilix" and $time == 0) {
            add_stack("initiative");
            reset_buff_time("initiative");

            if (defined $items{"hydras"} and $buffs{ "time" }->{ "hydras_lament" } <= $time) {
                $buffs{ "current" }->{ "hydras_lament" }= 1;
            }
        }


        #################################################################################
        # execute skills
        #################################################################################
        undef $next_skill;
        $next_skill = get_next_skill();
        if ( defined $next_skill ) {
            if ( $time >= $ability_stats{ "time" }->{ $next_skill } ) {
                # time to use next ability
                my $pre_prot_damage = $ability_stats{ "damage" }->{ $next_skill }->[
                        $ability_stats{ "level" }->{ $next_skill }->[ $opts{ "level" } ] ] +
                        (get_eff_power() * $ability_stats{ "scaling" }->{ $next_skill });
                my $hit = 0;
                if ( $buffs{ "current" }->{ "open_wound" } ) { $pre_prot_damage *= 1.15; }
                while ( $hit < $ability_stats{ "hits" }->{ $next_skill } ) {
                    if( $pre_prot_damage > 0 ) { 
                        if ( $next_skill eq "deathbane" ) {
                            # deathbane can crit
                            $pre_prot_damage = ability_crits( $pre_prot_damage );
                        }
                        if ( $opts{"action"} eq "clear" ) {
                            $damage += calc_mitigated_damage( $pre_prot_damage, $next_skill, 1,
                                    $ability_stats{ "aoe" }->{ $next_skill } );
                        } else {
                            $damage += calc_mitigated_damage( $pre_prot_damage, $next_skill, 1, 1 );
                        }
                        if(defined $items{"spear"}) {
                            reset_buff_time("spear");
                            add_stack("spear");
                        }
                        if(defined $items{"bluestone"}) {
                            # schedule ticks
                            my $i = 0;
                            my $aoe = 1;
                            if ( $opts{"action"} eq "clear" ) {
                                $aoe = $ability_stats{ "aoe" }->{ $next_skill };
                            }
                            add_bluestone( $aoe );
                        }
                    }
                    $hit++;
                }

                if ( 0 < $ability_stats{ "num_ticks" }->{ $next_skill } ) {
                    $pre_prot_damage = $ability_stats{ "tick_damage" }->{ $next_skill }->[
                            $ability_stats{ "level" }->{ $next_skill }->[ $opts{ "level" } ] ] +
                            (get_eff_power() * $ability_stats{ "tick_scaling" }->{ $next_skill });
                    if ( $buffs{ "current" }->{ "open_wound" } ) { $pre_prot_damage *= 1.15; }
                    # this ability has ticks, schedule them
                    my $i = 0;
                    while ( $i < $ability_stats{ "num_ticks" }->{ $next_skill } ) {

                        my $tick_time = $time + ($i + 1) * $ability_stats{ "tick_duration" }->{ $next_skill } * 1000;
                        while ( defined $ticks{ $tick_time } ) { $tick_time++; }
                        if ( $next_skill ne "last_breath" ) {
                            # not true damage
                            if ( $opts{"action"} eq "clear" and defined $ability_stats{ "aoe" }->{ $next_skill}) {
                                # if clearing, use aoe coefficient
                                $ticks{ $tick_time } = +[ $pre_prot_damage, "$next_skill tick", 0,
                                        $ability_stats{ "aoe" }->{ $next_skill} ];
                            } else {
                                $ticks{ $tick_time } = +[ $pre_prot_damage, "$next_skill tick", 0, 1 ];
                            }
                        } else {
                            $ticks{ $tick_time } = +[ $pre_prot_damage, "$next_skill tick", 1, 1 ];
                        }

                        $i++;
                    }
                }

                if ( $buffs{ "current" }->{ "open_wound" } ) {
                    $buffs{ "current" }->{ "open_wound" } = 0;
                } elsif ( $opts{ "god" } eq "bastet" ) {
                    $buffs{ "current" }->{ "open_wound" } = 1;
                }

                if ( $opts{ "god" } eq "serqet" ) {
                    add_stack( "serqet_poisons" );
                }

                if (defined $items{"polynomicon"} and $buffs{ "cooldown" }->{ "polynomicon" } <= $time) {
                    $buffs{ "current" }->{ "polynomicon" } = 1;
                }
                if (defined $items{"hydras"} and $buffs{ "cooldown" }->{ "hydras_lament" } <= $time) {
                    $buffs{ "current" }->{ "hydras_lament" } = 1;
                }

                $ability_stats{ "time" }->{ $next_skill } = $time +
                        (1000*($ability_stats{ "cooldown" }->{ $next_skill } * (1 - $cdr)));

                $next_attack_chain = 0;
                if ( $next_attack < $time + 1000 * $ability_stats{ "next_action" }->{ $next_skill } ) {
                    $next_attack = $time + 1000 * $ability_stats{ "next_action" }->{ $next_skill };
                }

                $combo_idx++;
            }
        }

        #################################################################################
        # execute ticks
        #################################################################################
        if ( defined $ticks{ $time } ) {

            if ( $ticks{ $time }->[ 2 ] == 0 ) {
                # not true damage
                $damage += calc_mitigated_damage(
                        $ticks{ $time }->[0], $ticks{ $time }->[1], 1, $ticks{ $time }->[3] );

                if ( $ticks{ $time }->[1] eq "bluestone" ) {
                    if ( not $ticks{ $time + 1000 }->[1] eq "bluestone" ) {
                        # TODO this is not guaranteed successful, there COULD be a tick of something
                        # already scheduled at that time, and the second bluestone would go 1ms later
                        # this is the second tick
                        $bluestone_stacks--;
                    }
                }
            } else {
                # true damage; here for last breath
                $damage += $ticks{ $time }->[0];
                if ( $opts{ "verbosity" } >= $VERBOSITY_EXTRA ) {
                    my $output = sprintf "time %d %s damage %d\n", $time, $ticks{ $time }->[1], $ticks{ $time }->[0];
                    push @one_pass_verbosity, $output;
                    if ( $opts{ "verbosity" } >= $VERBOSITY_EPIC ) {
                        print $output;
                    }
                }
            }
            
            # remove " tick" from name before trying to look it up in ability stats hash
            # TODO probably a cleaner way to do this
            my $skill_name = $ticks{ $time }->[ 1 ];
            $skill_name =~ s/\s+.*//;

            if(defined $items{"bluestone"} and defined $ability_stats{ "tick_damage" }->{
                        $skill_name } ) {
                # if this tick is an ability, schedule bluestone ticks
                # TODO only do this for 2 ticks!
                my $aoe = $ticks{ $time }->[3]; # borrow aoe coefficient from parent tick
                add_bluestone( $aoe );
            }


            if(defined $items{"spear"}) {
                reset_buff_time("spear");
                add_stack("spear");
            }
        }
        
        #################################################################################
        # execute buffs TODO can we merge these into the general skill logic?
        #################################################################################
        if ($opts{ "god" } eq "freya" and $time == 0) {
            reset_buff_time( "pulse" );
            add_stack( "pulse" );
            if ( $opts{"action"} ne "clear" ) {
                reset_buff_time( "irradiate" );
                add_stack( "irradiate" );
            }
            if (defined $items{"polynomicon"} and $buffs{ "cooldown" }->{ "polynomicon" } <= $time) {
                $buffs{ "current" }->{ "polynomicon" } = 1;
            }
        }

        if ($opts{ "god" } eq "sol" and $time >= $ability_stats{ "time" }->{ "radiance" }) {
            $heat += $radiance_heat_amount[
                   $ability_stats{ "level" }->{ "radiance" }->[ $opts{ "level" } ] ];
            if (defined $items{"polynomicon"} and $buffs{ "cooldown" }->{ "polynomicon" } <= $time) {
                $buffs{ "current" }->{ "polynomicon" } = 1;
            }
            $ability_stats{ "time" }->{ "radiance" } =
                    $time + 1000 * $ability_stats{ "cooldown" }->{ "radiance" };
        }

        if ($opts{ "god" } eq 'xbal' and $time == 0) {
            $buffs{ "current" }->{ "branching_bolas" }= 1;
        }

        if ($opts{ "god" } eq 'mercury' and $time == 0) {
            reset_buff_time("maximum_velocity");
            add_stack("maximum_velocity");
        }

        if ($opts{ "god" } eq "rama" and $time == 0) {
            reset_buff_time("pick_me_up");
            add_stack("pick_me_up");
            reset_buff_time("astral_strike");
            add_stack("astral_strike");
            $astral_arrows = 5;
        }

        if ($opts{ "god" } eq "ullr" and $time == 0) {
            add_stack("expose_weakness");
            reset_buff_time( "expose_weakness" );
        }

        if ($opts{ "god" } eq "artemis" and $time == 0) {
            # start with tusky
            #my $pre_prot_damage = 450 + $base_damage;
            #$damage += calc_mitigated_damage($pre_prot_damage);
            add_stack("vengeful_assault");
            reset_buff_time("vengeful_assault");
        }

        if ($opts{ "god" } eq "apollo" and $time == 0) {
            $audacity_stacks = 5;
        }

        #################################################################################
        # execute attack-chain dependent skills
        #################################################################################
        if ($opts{ "god" } eq "fenrir" and $num_attacks == 1 and
                    $ability_stats{ "time" }->{ "brutalize" } <= $time ) {

            # brutalize has very short AA cancel, do it after the first AA
            my $pre_prot_damage = $ability_stats{ "damage" }->{ "brutalize" }->[
                    $ability_stats{ "level" }->{ "brutalize" }->[ $opts{ "level" } ] ] +
                    (get_eff_power() * $ability_stats{ "scaling" }->{ "brutalize" });
            my $hit = 0;
            while ( $hit < $ability_stats{ "hits" }->{ "brutalize" } ) {
                if( $pre_prot_damage > 0 ) { 
                    if ( $opts{"action"} eq "clear" ) {
                        $damage += calc_mitigated_damage( $pre_prot_damage, $next_skill, 1,
                                $ability_stats{ "aoe" }->{ "brutalize" } );
                    } else {
                        $damage += calc_mitigated_damage( $pre_prot_damage, "brutalize", 1, 1 );
                    }
                    if(defined $items{"bluestone"}) {
                        # schedule ticks
                        my $aoe = 1;
                        if ( $opts{"action"} eq "clear" ) {
                            $aoe = $ability_stats{ "aoe" }->{ $next_skill };
                        }
                        add_bluestone( $aoe );
                    }
                }
                $hit++;
            }

            $ability_stats{ "time" }->{ "brutalize" } = $time +
                    1000 * $ability_stats{ "cooldown" }->{ "brutalize" };

            $next_attack = $time + 2000;

        }

        if ($opts{ "god" } eq "medusa" and $num_attacks == 1 and $viper_shots_left == 0 and $opts{"action"} ne "clear") {
            # start viper shot after the first AA for AA cancel benefit
            $viper_shots_left = 3;
            my $viper_attack_rate = $attack_rate +
                    $base_stats{ "attack_rate" }->{ $opts{ "god" } } * 
                    $ability_stats{ "attack_speed_buff" }->{ "viper_shot" }->[
                        $ability_stats{ "level" }->{ "viper_shot" }->[ $opts{ "level" } ] ];
            if ($viper_attack_rate > 2.5) {
                $messages_to_print{ "overcapping viper attack rate" } = 1;
                $viper_attack_rate = 2.5;
            }
            if (defined $items{"hydras"} and $buffs{ "cooldown" }->{ "hydras_lament" } <= $time) {
                $buffs{ "current" }->{ "hydras_lament" }= 1;
            }

            my $viper_attack_duration = int(1000 / $viper_attack_rate);
            $next_attack = $time + $viper_attack_duration;
        }

        if ($opts{ "god" } eq "awilix" and $next_attack_chain == 2 and
                $ability_stats{ "time" }->{ "feather_step" } <= $time ) {
            # time to feather step
            my $pre_prot_damage = $ability_stats{ "damage" }->{ "feather_step" }->[
                    $ability_stats{ "level" }->{ "feather_step" }->[ $opts{ "level" } ] ]
                    + ($ability_stats{ "scaling" }->{ "feather_step" } * get_eff_power());

            $damage += calc_mitigated_damage($pre_prot_damage, "feather step", 1, 1);

            # reset attack chain
            $next_attack_chain = 0;
            $next_attack = $time + 250; # don't know actual AA cancel durations

            if (defined $items{"hydras"} and $buffs{ "cooldown" }->{ "hydras_lament" } <= $time) {
                $buffs{ "current" }->{ "hydras_lament" }= 1;
            }

            $ability_stats{ "time" }->{ "feather_step" } = $time +
                    (1000*($ability_stats{ "cooldown" }->{ "feather_step" } * (1 - $cdr)));
        }



        #################################################################################
        # execute basic attacks
        #################################################################################
        if ( $time == $next_attack ) {

            my $pre_prot_damage = get_basic_attack_damage();
            
            if($buffs{ "current" }->{ "expose_weakness" }) { 
                $pre_prot_damage += $ability_stats{ "power_buff" }->{ "expose_weakness" }->[
                        $ability_stats{ "level" }->{ "expose_weakness" }->[ $opts{ "level" } ] ];
            }

            if($buffs{ "current" }->{ "branching_bolas" }) { 
                $pre_prot_damage += $ability_stats{ "power_buff" }->{ "branching_bolas" }->[
                        $ability_stats{ "level" }->{ "branching_bolas" }->[ $opts{ "level" } ] ];
            }

            if($buffs{ "current" }->{ "astral_strike" } and $astral_arrows > 0) {
                $astral_arrows--;
                $pre_prot_damage += $ability_stats{ "damage" }->{ "astral_strike" }->[
                        $ability_stats{ "level" }->{ "astral_strike" }->[ $opts{ "level" } ] ];
            }

            if ( $opts{ "god" } eq "mercury" and $num_attacks == 0 ) {
                # assume passiv is procced on first auto
                $pre_prot_damage += get_eff_power() * 0.75;
            }

            if ( $opts{ "god" } eq "mercury" ) {
                $pre_prot_damage += 0.3 * get_mvmt_speed();
            }

            # crit chance
            my $total_crit_chance = $base_crit_chance;

            if ($opts{ "god" } eq "artemis") {
                $total_crit_chance += 0.05 * $buffs{ "current" }->{ "still_target" };

                add_stack( "still_target" );
                reset_buff_time( "still_target" );
            }

            if (defined $items{ "rage" }) {
                $total_crit_chance += 0.1 * $buffs{ "current" }->{ "rage" };
            }

            my $rng = rand();
            if ( $rng < $total_crit_chance ) {
                # critical hit
                $pre_prot_damage *= 2;
                if (defined $items{ "deathbringer" }) {
                    $pre_prot_damage *= 1.2; # 240%
                }
                $crits++;

                # handle rage
                $buffs{ "current" }->{ "rage" } = 0;

                # handle malice
                if ($malice_procs_left == 0) {
                    # no procs, set next proc for 1 sec from now, otherwise just refresh count
                    $next_malice_proc = $time + 1000;
                }
                $malice_procs_left = 3;
            }
            else
            {
                add_stack( "rage" );
            }

            # ability buffs
            if ($buffs{ "current" }->{ "pulse" }) {
                $pre_prot_damage += $ability_stats{ "damage" }->{ "pulse" }->[
                        $ability_stats{ "level" }->{ "pulse" }->[ $opts{ "level" } ] ] + 0.15 * get_eff_power();
            }

            if ($buffs{ "current" }->{ "irradiate" }) {
                $pre_prot_damage += $ability_stats{ "damage" }->{ "irradiate" }->[
                        $ability_stats{ "level" }->{ "irradiate" }->[ $opts{ "level" } ] ] + 0.25 * get_eff_power();
            }

            if ($buffs{ "current" }->{ "serqet_poisons" } >= 2) {
                $pre_prot_damage += $their_health * 0.1;
                if ($buffs{ "current" }->{ "serqet_poisons" } == 3) {
                    $pre_prot_damage += $their_health * 0.1;
                }
            }
            $buffs{ "current" }->{ "serqet_poisons" } = 0;

            # apply sol's bonus only to her base damage, not to polynomicon / telkhines / etc.
            if ( $opts{ "god" } eq "sol" and $heat == 100 ) { $pre_prot_damage *= 1.25; }

            # add viper shot extra damage
            if ($viper_shots_left > 0) {
                $viper_shots_left--;
                my $pre_prot_damage = $ability_stats{ "tick_damage" }->{ "viper_shot" }->[
                        $ability_stats{ "level" }->{ "viper_shot" }->[ $opts{ "level" } ] ]
                         + get_eff_power() * $ability_stats{ "tick_scaling" }->{ "viper_shot" };
                my $i = 0;
                # this ability has ticks, schedule them
                while ( $i < 3 ) {
                    # viper shot 3 ticks at 0.5 seconds
                    my $tick_time = $time + ($i + 1) * 0.5 * 1000;
                    while ( defined $ticks{ $tick_time } ) { $tick_time++; }
                    $ticks{ $tick_time } = +[ $pre_prot_damage, "viper shot tick", 0,
                            $ability_stats{ "aoe" }->{ "viper_shot" } ];

                    $i++;
                }
            }


            # item buffs

            if($buffs{ "current" }->{ "hydras_lament" }) {
                $hydras_damage += 0.25 * get_basic_attack_damage();
                $hydras_procs++;
                $pre_prot_damage += 0.25 * get_basic_attack_damage();
                $buffs{ "current" }->{ "hydras_lament" } = 0;
                reset_buff_time( "hydras_lament" );
            }

            if ($buffs{ "current" }->{ "polynomicon" }) {
                $damage += calc_mitigated_damage( 0.75 * get_eff_power(), "polynomicon", 1, 1 );
                $polynomicon_procs++;
                $polynomicon_damage = int(calc_mitigated_damage( 0.75 * get_eff_power(), "polynomicon", 0, 1 ));
                $buffs{ "current" }->{ "polynomicon" } = 0;
                reset_buff_time("polynomicon");
            }

            if (defined $items{"telkhines_ring"} or defined $items{ "telkhines" }) {
                #$pre_prot_damage += 35;
                $damage += calc_mitigated_damage( 35, "telkhines", 1, 1 );
                $telkhines_damage += calc_mitigated_damage( 35, "telkhines", 0, 1 );
            }

            if (defined $items{ "qins" }) {
                $pre_prot_damage += 0.04 * $their_health;
            }

            if ($opts{"action"} eq "clear" and defined $items{"obow"}) {
                if ($obow_hits == 3) {
                    $obow_hits = 0;
                    my $obow_damage = 0.5 * get_eff_power() + 30;
                    $damage += calc_mitigated_damage( $obow_damage, "obow", 1, 5 );
                }
                else
                {
                    $obow_hits++;
                }
            }

            if ($opts{"action"} eq "clear" and defined $items{"charged_bow"}) {
                if ($obow_hits == 3) {
                    $obow_hits = 0;
                    my $obow_damage = 20;
                    $damage += calc_mitigated_damage( $obow_damage, "charged_bow", 1, 5 );
                }
                else
                {
                    $obow_hits++;
                }
            }

            # all damage calcs done, execute the attack
            if ( $opts{"action"} eq "clear" and defined $items{ "golden_bow" } ) {
                $damage += calc_mitigated_damage($pre_prot_damage, "attack", 1, 1);
                $damage += calc_mitigated_damage(0.5 * $pre_prot_damage, "attack", 1, 2);
                $attack_damage += calc_mitigated_damage($pre_prot_damage, "attack", 0, 1);
                $attack_damage += calc_mitigated_damage(0.5 * $pre_prot_damage, "attack", 0, 2);
            } elsif ( $opts{"action"} eq "clear" and defined $items{ "throwing_dagger" } ) {
                $damage += calc_mitigated_damage($pre_prot_damage, "attack", 1, 1);
                $damage += calc_mitigated_damage(0.25 * $pre_prot_damage, "attack", 1, 2);
                $attack_damage += calc_mitigated_damage($pre_prot_damage, "attack", 0, 1);
                $attack_damage += calc_mitigated_damage(0.25 * $pre_prot_damage, "attack", 0, 2);
            } elsif ( $opts{"action"} eq "clear" and
                    $buffs{ "current" }->{ "pulse" } and not $buffs{ "current" }->{ "irradiate" }) {
                $damage += calc_mitigated_damage($pre_prot_damage, "attack", 1, 3);
                $attack_damage += calc_mitigated_damage($pre_prot_damage, "attack", 0, 3);
            } else {
                $damage += calc_mitigated_damage($pre_prot_damage, "attack", 1, 1);
                $attack_damage += calc_mitigated_damage($pre_prot_damage, "attack", 0, 1);
            }

            # get ready for next attack
            if (defined $items{"spear"} and
                    ($buffs{ "current" }->{ "pulse" } or $buffs{ "current" }->{ "irradiate" })) {
                reset_buff_time( "spear" );
                add_stack("spear");
            }

            if (defined $items{"demonic_grip"}) {
                reset_buff_time( "demonic_grip" );
                add_stack("demonic_grip");
            }

            if (defined $items{ "ichaival" }) {
                reset_buff_time( "ichaival" );
                add_stack("ichaival");
            }

            if (defined $items{ "executioner" }) {
                reset_buff_time( "executioner" );
                add_stack("executioner");
            }

            if (defined $items{ "stone_cutting_sword" } or defined $items{ "scs" }) {
                reset_buff_time( "stone_cutting_sword" );
                add_stack("stone_cutting_sword");
            }

            # attack chain progression
            my $eff_attack_rate = $attack_rate;
            if ( $opts{ "god" } eq "sol" ) {
                $eff_attack_rate = $attack_rate +
                        $base_stats{ "attack_rate" }->{ $opts{ "god" } } * ($heat * 0.25 * 0.012);
                $messages_to_print{ "heat effective attack rate" } = $eff_attack_rate;
            }
            if ( $opts{ "god" } eq "ullr" ) {
                $eff_attack_rate = $attack_rate +
                        $ability_stats{ "attack_speed_buff" }->{ "wield_bow" }->[
                        $ability_stats{ "level" }->{ "wield_bow" }->[ $opts{ "level" } ] ]
                        * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
            }
            if ( $buffs{ "current" }->{ "vengeful_assault" } ) {
                $eff_attack_rate = $attack_rate + 
                $ability_stats{ "attack_speed_buff" }->{ "vengeful_assault" }->[
                        $ability_stats{ "level" }->{ "vengeful_assault" }->[ $opts{ "level" } ] ]
                        * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
            }
            if ( $buffs{ "current" }->{ "pick_me_up" } ) { 
                $eff_attack_rate = $attack_rate + 0.5 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
                # TODO use normal stats logic
            }
            if ( $buffs{ "current" }->{ "maximum_velocity" } ) {
                $eff_attack_rate = $attack_rate + 0.7 * $base_stats{ "attack_rate" }->{ $opts{ "god" } };
                # TODO use normal stats logic
            }
            if ( $audacity_stacks > 0) {
                $eff_attack_rate = $attack_rate + $base_stats{ "attack_rate" }->{ $opts{ "god" } };
                $audacity_stacks--;
            }
            if ($viper_shots_left > 0) {
                $eff_attack_rate = $attack_rate +
                        $base_stats{ "attack_rate" }->{ $opts{ "god" } } * 
                        $ability_stats{ "attack_speed_buff" }->{ "vengeful_assault" }->[
                        $ability_stats{ "level" }->{ "vengeful_assault" }->[ $opts{ "level" } ] ];
            }

            if ( $eff_attack_rate > 2.5 ) { $eff_attack_rate = 2.5; }

            my $eff_attack_duration = int(1000 / $eff_attack_rate);
            $next_attack = $time + int($eff_attack_duration * ${attack_chain_progression}[ $next_attack_chain ]);
            $next_attack_chain++;
            if ($next_attack_chain >= scalar @attack_chain_progression ) { $next_attack_chain = 0; }

            $num_attacks++;

            $heat += 5;
            if ( $heat > 100 ) { $heat = 100; }
        }

        #################################################################################
        # get ready for next tick of time
        #################################################################################


        if ( defined $items{ "malice" }
                and $time == $next_malice_proc and $malice_procs_left > 0 )
        {
            $total_malice_procs++;
            my $pre_prot_damage = 0.25 * get_basic_attack_damage();

            $damage += calc_mitigated_damage($pre_prot_damage, "malice", 1, 1);
            $malice_damage += calc_mitigated_damage($pre_prot_damage, "malice", 0, 1);

            $malice_procs_left -= 1;
            $next_malice_proc += 1000;
        }

        foreach my $buff (keys $buffs{ "time" } ) {
            if ( $time == $buffs{ "time" }->{ $buff } and $time != 0 ) {
                # time's up, reset stacks for this buff
                $buffs{ "current" }->{ $buff } = 0;
            }
        }

        $time++;

    }

    #################################################################################
    # get ready for next iteration
    #################################################################################
    foreach my $ability ( keys $ability_stats{ "time" } )
    {
        # reset all cooldowns
        $ability_stats{ "time" }->{ $ability } = 0;
    }
    foreach my $buff ( keys $buffs{ "time" } ) {
        # reset all buffs
        $buffs{ "time" }->{ $buff } = 0;
        $buffs{ "current" }->{ $buff } = 0;
    }
    %ticks = ();
    $time = 0;
    $combo_idx = 0;
    $next_attack = 0;
    $next_attack_chain = 0;
    $total_attacks += $num_attacks;
    $num_attacks = 0;
    $malice_procs_left = 0;
    $next_malice_proc = 0;
    $viper_shots_left = 0;

    $iteration++;

}

#################################################################################
# output
#################################################################################
foreach my $key (keys %messages_to_print) {
        print $key . " " . $messages_to_print{ $key} . "\n";
}

foreach my $line ( @one_pass_verbosity ){
    print $line;
}

printf "Total damage %.2f DPS %.2f\n", $damage/$max_iterations, ($damage / ($max_iterations*$opts{"time"}/1000));
if ( $opts{ "verbosity" } >= $VERBOSITY_NORMAL ) {
    print "effective power " . get_eff_power() . "\n";
    print "base attack damage " . get_basic_attack_damage() . "\n";
    print "base attack rate $attack_rate\n";
    printf "Num attacks: %d avg damage %.2f\n", $total_attacks/$max_iterations, ($attack_damage /$total_attacks);
    printf "Damage from basic attacks %.2f Other damage %.2f\n", ($attack_damage/$max_iterations), (($damage - $attack_damage)/$max_iterations);
    if ( defined $enemy_items{"nemean"} ) {
        # assume 30 + 0.9 * 20 = 48 magical protections TODO this could be more accurate
        printf "Damage return from Nemean %.2f\n", ($attack_damage/$max_iterations) * 0.2 / 1.48;
    }
    if ( defined $items{ "polynomicon" } ) {
        print "Polynomicon procs $polynomicon_procs polynomicon damage $polynomicon_damage\n";
    }
    if ( defined $items{ "telkhines" } or defined $items{ "telkhines_ring" } ) {
        printf "Telkhines damage %.2f\n", $telkhines_damage;
    }
    if ( defined $items{ "hydras" } ) {
        print "Hydras procs $hydras_procs hydras damage $hydras_damage\n";
    }
    if ( $base_stats{ "type" }->{ $opts{ "god" } } eq "physical" ) {
        printf "Num crits: %d total crit chance %.2f\n", $crits/$max_iterations, ($crits / $total_attacks);
    }
    if (defined $items{ "malice" }) {
        printf  "Total Malice procs %d Malice procs/crit %.2f Malice damage %.2f Malice bonus damage per crit %.2f\n", $total_malice_procs/$max_iterations, ($total_malice_procs/$crits), $malice_damage/$max_iterations, ($malice_damage)/($crits);
    }
    printf "Total lifesteal %.2f\n", ($damage * $lifesteal)/$max_iterations;
    printf "Total gold %d damage/gold %.2f\n", $gold, ($damage/$max_iterations) / $gold;
}


